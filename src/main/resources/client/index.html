<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="shortcut icon" type="image/ico" href="" />
		
		<title>UK&Int Dashboard</title>
		<style type="text/css" title="currentStyle">
			//@import "base.css";
		</style>

		<script type="text/javascript" src="lib/jquery-1.10.2.min.js"></script>

		<script type="text/javascript">

	        function getEvents(){

	        	var filter = $("#filterProjectId").val();
	        	
	        	if (filter.length >0) filter = "/"+ filter;

				$.ajax({
				           type: 'GET',
				           url: "/rest/report/events"+ filter,
				           processData: true,
				           data: {},
				           dataType: "json",
				           success: function (data) {
				               buildTable(data);
				           }
				});

	        }

	        function getLastEvent(){

	        	var filter = $("#project_id").val();
	        	
	        	if (filter.length >0) filter = "/"+ filter;

				$.ajax({
				           type: 'GET',
				           url: "/rest/report/events"+ filter,
				           processData: true,
				           data: {},
				           dataType: "json",
				           success: function (data) {
				           	$.each(data, function(index, element) {
					            populate($("#eventForm"), element);
					        });
			               
				           }
				});

	        }

	        function populate(frm, data) {   
			    /*$.each(data, function(key, value){
				    $('[name='+key+']', frm).val(value);
				  });*/

			    $.each(data, function(key, value){  
			    var $ctrl = $('[name='+key+']', frm);  
			    switch($ctrl.attr("type"))  
			    {  
			        case "text" :   
			        case "hidden":  
			        case "textarea":  
			        $ctrl.val(value);   
			        break;   
			        case "radio" : case "checkbox":   
			        $ctrl.each(function(){
			           if($(this).attr('value') == value) {  $(this).attr("checked",value); } });   
			        break;  
			    }  
			    });  

			}

			// Builds the HTML Table out of myList.
			function buildTable(myList) {


			    var columns = addAllColumnHeaders(myList);

			    for (var i = 0 ; i < myList.length ; i++) {
			        var row$ = $('<tr/>');
			        for (var colIndex = 0 ; colIndex < columns.length ; colIndex++) {
			            var cellValue = myList[i][columns[colIndex]];

			            if (cellValue == null) { cellValue = ""; }

			            row$.append($('<td/>').html(cellValue));
			        }
			        $("#excelDataTable").append(row$);
			    }
			}

			// Adds a header row to the table and returns the set of columns.
			// Need to do union of keys from all records as some records may not contain
			// all records
			function addAllColumnHeaders(myList){
			    var columnSet = [];
			    var headerTr$ = $('<tr/>');

			    for (var i = 0 ; i < myList.length ; i++) {
			        var rowHash = myList[i];
			        for (var key in rowHash) {
			            if ($.inArray(key, columnSet) == -1){
			                columnSet.push(key);
			                headerTr$.append($('<th/>').html(key));
			            }
			        }
			    }
			    $("#excelDataTable").html(headerTr$);
			    return columnSet;
			}

	 </script>

	</head>
	<body onLoad="getEvents();">
			<h1>
				UK&Int Dashboard
			</h1>
			
			<h2>Add new Event</h2>

			<form id="eventForm">
				<label for="project_id">Project Id</label><input type="text" name="project_id" id="project_id" size="4" onChange="getLastEvent();" />
				<label for="country">Country</label><input type="text" name="country" id="country" size="4"/>
				<label for="project_type">Project Type</label><input type="text" name="project_type" id="project_type" size="20"/>
				<label for="date">Date</label><input type="text" name="date" id="date" size="10"/>
				<label for="type">Type</label><input type="text" name="type" id="type" size="30"/>
				<label for="event">Event</label><input type="text" name="event" id="event" size="30"/>
				<label for="impact">Impact</label><input type="text" name="impact" id="impact" size="4"/>
				<label for="reason">Reason</label><input type="text" name="reason" id="reason" size="30"/>
				<label for="timelines">Timelines</label><input type="text" name="timelines" id="timelines" size="50"/>
				<input type="submit" name="submit" id="createEvent" value="add"/>
			</form>
			<script type="text/javascript">
			$("#eventForm").submit(function() {

				    var url = "/rest/report/events";

				    $.ajax({
				           type: "POST",
				           url: url,
				           data: $("#eventForm").serialize(), // serializes the form's elements.
				           success: function(data)
				           {
				               getEvents();
				           }
				         });

				    //ev.preventDefault(); // avoid to execute the actual submit of the form.
				    return false;
				});
			</script>


			<h2>List of Events</h2>
			<label for="filterProjectId">Filter by Project Id: </label><input type="text" name="filterProjectId"  value="empty" id="filterProjectId" size="4" onChange="getEvents();"/><br />
			<table id="excelDataTable" border="1"></table>
	</body>â€‹
</html>